# ğŸš€ é€‰è¯¾ç¤¾åŒºç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

## ğŸ“‹ æœåŠ¡å™¨ä¿¡æ¯
- **IPåœ°å€**: 101.36.111.202 (é¦™æ¸¯)
- **ç³»ç»Ÿ**: Ubuntu 22.04 LTS  
- **åŸŸå**: swufe.kaixuebang.com
- **ç”¨æˆ·**: ubuntu / zou17871788835zou

## ğŸ¯ éƒ¨ç½²ç›®æ ‡
- ç”Ÿäº§çº§Django + Next.jsåº”ç”¨
- PostgreSQL + Redisæ•°æ®å­˜å‚¨
- Nginxåå‘ä»£ç† + SSLè¯ä¹¦
- systemdæœåŠ¡ç®¡ç† + å¼€æœºè‡ªå¯

## ğŸ”„ å¿«é€Ÿéƒ¨ç½²ï¼ˆæ¨èï¼‰

### æ­¥éª¤1: ä¸Šä¼ é¡¹ç›®æ–‡ä»¶
```bash
# æœ¬åœ°æ‰§è¡Œ
scp jcourse_production_*.tar.gz ubuntu@101.36.111.202:/tmp/
ssh ubuntu@101.36.111.202
sudo su -
cd /tmp && tar -xzf jcourse_production_*.tar.gz
mv jcourse_production_* /opt/jcourse
cd /opt/jcourse
chmod +x ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è„šæœ¬.sh
bash ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²è„šæœ¬.sh
```

## ğŸ› ï¸ æ‰‹åŠ¨éƒ¨ç½²æ­¥éª¤

### 1. ç³»ç»Ÿç¯å¢ƒå‡†å¤‡
```bash
# æ›´æ–°ç³»ç»Ÿ
apt update && apt upgrade -y

# å®‰è£…åŸºç¡€ä¾èµ–
apt install -y curl wget git unzip software-properties-common \
    apt-transport-https ca-certificates gnupg build-essential \
    supervisor certbot python3-certbot-nginx ufw

# å®‰è£…Python 3.11
add-apt-repository ppa:deadsnakes/ppa -y
apt update && apt install -y python3.11 python3.11-venv python3.11-dev python3-pip
update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.11 1

# å®‰è£…Node.js 18 LTS
curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
apt install -y nodejs
npm install -g yarn pm2

# å®‰è£…æ•°æ®åº“
apt install -y postgresql postgresql-contrib redis-server nginx
```

### 2. åˆ›å»ºç”¨æˆ·å’Œç›®å½•
```bash
useradd -m -s /bin/bash jcourse
mkdir -p /opt/jcourse/{logs,static,media}
chown -R jcourse:jcourse /opt/jcourse
```

### 3. é…ç½®æ•°æ®åº“
```bash
systemctl start postgresql redis-server
systemctl enable postgresql redis-server

sudo -u postgres psql << 'EOF'
CREATE DATABASE jcourse_db;
CREATE USER jcourse_user WITH PASSWORD 'jcourse_password_2024';
ALTER ROLE jcourse_user SET client_encoding TO 'utf8';
ALTER ROLE jcourse_user SET default_transaction_isolation TO 'read committed';
ALTER ROLE jcourse_user SET timezone TO 'Asia/Shanghai';
GRANT ALL PRIVILEGES ON DATABASE jcourse_db TO jcourse_user;
\q
EOF
```

### 4. é…ç½®åç«¯æœåŠ¡
```bash
cd /opt/jcourse/jcourse_api-master
sudo -u jcourse python3.11 -m venv venv
sudo -u jcourse bash -c "
    source venv/bin/activate
    pip install --upgrade pip
    pip install -r requirements_compatible.txt
    pip install gunicorn psycopg2-binary
"

# ç”Ÿäº§ç¯å¢ƒé…ç½®
cat > jcourse/production_settings.py << 'EOF'
from .settings import *
DEBUG = False
ALLOWED_HOSTS = ['swufe.kaixuebang.com', '101.36.111.202']
DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'jcourse_db',
        'USER': 'jcourse_user',
        'PASSWORD': 'jcourse_password_2024',
        'HOST': 'localhost',
        'PORT': '5432',
    }
}
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.redis.RedisCache',
        'LOCATION': 'redis://127.0.0.1:6379/1',
    }
}
STATIC_ROOT = '/opt/jcourse/static'
MEDIA_ROOT = '/opt/jcourse/media'
CORS_ORIGIN_WHITELIST = ['https://swufe.kaixuebang.com']
SECURE_SSL_REDIRECT = True
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True
EOF
```

### 5. æ‰§è¡Œæ•°æ®åº“è¿ç§»
```bash
sudo -u jcourse bash -c "
    cd /opt/jcourse/jcourse_api-master
    source venv/bin/activate
    export DJANGO_SETTINGS_MODULE=jcourse.production_settings
    python manage.py migrate
    python manage.py collectstatic --noinput
    echo \"from django.contrib.auth.models import User; User.objects.filter(username='admin').exists() or User.objects.create_superuser('admin', 'admin@swufe.edu.cn', 'admin123456')\" | python manage.py shell
"
```

### 6. é…ç½®å‰ç«¯
```bash
cd /opt/jcourse/jcourse-master
cat > .env.local << 'EOF'
NEXT_PUBLIC_API_URL=https://swufe.kaixuebang.com/api
NEXT_PUBLIC_SITE_URL=https://swufe.kaixuebang.com
NODE_ENV=production
EOF

sudo -u jcourse bash -c "
    cd /opt/jcourse/jcourse-master
    yarn install && yarn build
"
```

### 7. åˆ›å»ºsystemdæœåŠ¡
```bash
# åç«¯æœåŠ¡
cat > /etc/systemd/system/jcourse-backend.service << 'EOF'
[Unit]
Description=JCourse Backend
After=network.target postgresql.service redis.service

[Service]
Type=notify
User=jcourse
WorkingDirectory=/opt/jcourse/jcourse_api-master
Environment=DJANGO_SETTINGS_MODULE=jcourse.production_settings
ExecStart=/opt/jcourse/jcourse_api-master/venv/bin/gunicorn --bind 127.0.0.1:8000 --workers 3 jcourse.wsgi:application
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# å‰ç«¯æœåŠ¡
cat > /etc/systemd/system/jcourse-frontend.service << 'EOF'
[Unit]
Description=JCourse Frontend
After=network.target

[Service]
Type=exec
User=jcourse
WorkingDirectory=/opt/jcourse/jcourse-master
Environment=NODE_ENV=production
ExecStart=/usr/bin/yarn start
Restart=always

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable jcourse-backend jcourse-frontend
```

### 8. é…ç½®Nginx
```bash
cat > /etc/nginx/sites-available/jcourse << 'EOF'
server {
    listen 80;
    server_name swufe.kaixuebang.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name swufe.kaixuebang.com;
    
    ssl_certificate /etc/letsencrypt/live/swufe.kaixuebang.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/swufe.kaixuebang.com/privkey.pem;
    
    location /static/ { alias /opt/jcourse/static/; }
    location /media/ { alias /opt/jcourse/media/; }
    location /api/ { proxy_pass http://127.0.0.1:8000; }
    location /admin/ { proxy_pass http://127.0.0.1:8000; }
    location / { proxy_pass http://127.0.0.1:3000; }
}
EOF

ln -sf /etc/nginx/sites-available/jcourse /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default
```

### 9. è·å–SSLè¯ä¹¦
```bash
systemctl stop nginx
certbot certonly --standalone -d swufe.kaixuebang.com --agree-tos --email admin@swufe.edu.cn
echo "0 12 * * * /usr/bin/certbot renew --quiet" | crontab -
```

### 10. é…ç½®é˜²ç«å¢™å¹¶å¯åŠ¨æœåŠ¡
```bash
ufw default deny incoming
ufw default allow outgoing
ufw allow ssh && ufw allow 80 && ufw allow 443
ufw --force enable

systemctl start jcourse-backend jcourse-frontend nginx
systemctl enable nginx
```

## ğŸ“Š éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status jcourse-backend jcourse-frontend nginx postgresql redis-server

# æ£€æŸ¥ç«¯å£ç›‘å¬
ss -tlnp | grep -E "(80|443|8000|3000|5432|6379)"

# æµ‹è¯•è®¿é—®
curl -I http://swufe.kaixuebang.com
curl -I https://swufe.kaixuebang.com
```

## ğŸŒ è®¿é—®åœ°å€

- **ä¸»ç«™**: https://swufe.kaixuebang.com
- **ç®¡ç†åå°**: https://swufe.kaixuebang.com/admin
- **API**: https://swufe.kaixuebang.com/api/
- **ç®¡ç†å‘˜**: admin / admin123456

## ğŸ”§ å¸¸ç”¨ç®¡ç†å‘½ä»¤

```bash
# é‡å¯æœåŠ¡
systemctl restart jcourse-backend jcourse-frontend nginx

# æŸ¥çœ‹æ—¥å¿—
journalctl -u jcourse-backend -f
journalctl -u jcourse-frontend -f
tail -f /var/log/nginx/swufe.kaixuebang.com.error.log

# æ›´æ–°ä»£ç 
cd /opt/jcourse
# æ›¿æ¢æ–°ä»£ç å
sudo -u jcourse bash -c "cd jcourse_api-master && source venv/bin/activate && python manage.py migrate && python manage.py collectstatic --noinput"
sudo -u jcourse bash -c "cd jcourse-master && yarn build"
systemctl restart jcourse-backend jcourse-frontend

# æ•°æ®åº“å¤‡ä»½
sudo -u postgres pg_dump jcourse_db > /opt/jcourse/backup_$(date +%Y%m%d).sql
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **åŸŸåè§£æ**: å¿…é¡»å…ˆå°† `swufe.kaixuebang.com` è§£æåˆ° `101.36.111.202`
2. **SSLè¯ä¹¦**: åŸŸåè§£æç”Ÿæ•ˆåæ‰èƒ½è·å–è¯ä¹¦
3. **å®‰å…¨ç»„**: ç¡®ä¿äº‘æœåŠ¡å™¨å¼€æ”¾80ã€443ã€22ç«¯å£
4. **è‡ªåŠ¨å¯åŠ¨**: æ‰€æœ‰æœåŠ¡å·²é…ç½®å¼€æœºè‡ªå¯
5. **æ—¥å¿—è½®è½¬**: å»ºè®®é…ç½®logrotateé˜²æ­¢æ—¥å¿—è¿‡å¤§

## ğŸš¨ æ•…éšœæ’é™¤

### åŸŸåæ— æ³•è®¿é—®
```bash
# æ£€æŸ¥åŸŸåè§£æ
nslookup swufe.kaixuebang.com
# æ£€æŸ¥é˜²ç«å¢™
ufw status
# æ£€æŸ¥Nginxé…ç½®
nginx -t && systemctl status nginx
```

### SSLè¯ä¹¦é—®é¢˜
```bash
# æ‰‹åŠ¨è·å–è¯ä¹¦
systemctl stop nginx
certbot certonly --standalone -d swufe.kaixuebang.com
systemctl start nginx
```

### åº”ç”¨æœåŠ¡å¼‚å¸¸
```bash
# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
journalctl -u jcourse-backend -n 50
journalctl -u jcourse-frontend -n 50
# æ‰‹åŠ¨æµ‹è¯•
sudo -u jcourse bash -c "cd /opt/jcourse/jcourse_api-master && source venv/bin/activate && python manage.py check"
```

éƒ¨ç½²å®Œæˆåï¼Œæ‚¨çš„é€‰è¯¾ç¤¾åŒºå°†åœ¨ https://swufe.kaixuebang.com æ­£å¼ä¸Šçº¿ï¼ 